name: Build DevContainer Images

on:
  schedule:
    - cron: '0 0 10 * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - create-devcontainer
    paths:
      - '.devcontainer/**'

permissions:
  contents: read
  packages: write
  security-events: write

env:
  REGISTRY: ghcr.io
  OWNER: nakatatsu

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image: [infrastructure, backend, frontend, local]

    steps:
      - uses: actions/checkout@v4

      - name: Load versions
        id: versions
        run: |
          while IFS='=' read -r key value; do
            [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
            key_lower=$(echo "$key" | tr '[:upper:]' '[:lower:]')
            echo "${key_lower}=${value}" >> $GITHUB_OUTPUT
          done < .devcontainer/versions.env
          echo "build_date=$(date -u +'%Y-%m')" >> $GITHUB_OUTPUT

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .devcontainer
          file: .devcontainer/dockerfiles/Dockerfile.${{ matrix.image }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.OWNER }}/devcontainer-${{ matrix.image }}:latest
            ${{ env.REGISTRY }}/${{ env.OWNER }}/devcontainer-${{ matrix.image }}:${{ steps.versions.outputs.build_date }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.OWNER }}/devcontainer-${{ matrix.image }}:latest
          cache-to: type=inline
          build-args: |
            NODE_VERSION=${{ steps.versions.outputs.node_version }}
            CLAUDE_CODE_VERSION=${{ steps.versions.outputs.claude_code_version }}
            AWS_CLI_VERSION=${{ steps.versions.outputs.aws_cli_version }}
            GIT_DELTA_VERSION=${{ steps.versions.outputs.git_delta_version }}
            ZSH_IN_DOCKER_VERSION=${{ steps.versions.outputs.zsh_in_docker_version }}
            TERRAFORM_VERSION=${{ steps.versions.outputs.terraform_version }}
            TFLINT_VERSION=${{ steps.versions.outputs.tflint_version }}
            CHECKOV_VERSION=${{ steps.versions.outputs.checkov_version }}
            TERRAFORM_DOCS_VERSION=${{ steps.versions.outputs.terraform_docs_version }}
            GO_VERSION=${{ steps.versions.outputs.go_version }}
            GOFUMPT_VERSION=${{ steps.versions.outputs.gofumpt_version }}
            GOIMPORTS_VERSION=${{ steps.versions.outputs.goimports_version }}
            GOLANGCI_LINT_VERSION=${{ steps.versions.outputs.golangci_lint_version }}
            GOVULNCHECK_VERSION=${{ steps.versions.outputs.govulncheck_version }}
            OSV_SCANNER_VERSION=${{ steps.versions.outputs.osv_scanner_version }}
            GOSEC_VERSION=${{ steps.versions.outputs.gosec_version }}
            NEXTJS_VERSION=${{ steps.versions.outputs.nextjs_version }}

      - name: Security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.OWNER }}/devcontainer-${{ matrix.image }}:latest
          format: sarif
          output: trivy-results.sarif

      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
          category: devcontainer-${{ matrix.image }}
