# DevContainer Infrastructure Image
# Self-contained multi-stage build for CI/CD infrastructure tasks

# Stage 1: Base
ARG NODE_VERSION
FROM node:${NODE_VERSION} AS base

ARG CLAUDE_CODE_VERSION
ARG AWS_CLI_VERSION
ARG GIT_DELTA_VERSION
ARG ZSH_IN_DOCKER_VERSION
ARG TZ=UTC

ENV TZ="$TZ"
ENV DEVCONTAINER=true
ENV NPM_CONFIG_PREFIX=/usr/local/share/npm-global
ENV PATH=$PATH:/usr/local/share/npm-global/bin
ENV SHELL=/bin/zsh
ENV EDITOR=nano
ENV VISUAL=nano

COPY scripts/install-base.sh /tmp/
RUN bash /tmp/install-base.sh && rm /tmp/install-base.sh

USER node

RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v${ZSH_IN_DOCKER_VERSION}/zsh-in-docker.sh)" -- \
  -p git -p fzf \
  -a "source /usr/share/doc/fzf/examples/key-bindings.zsh" \
  -a "source /usr/share/doc/fzf/examples/completion.zsh" \
  -a "export PROMPT_COMMAND='history -a' && export HISTFILE=/commandhistory/.bash_history" \
  -x

RUN npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION}

COPY scripts/init-firewall.sh /usr/local/bin/
USER root
RUN chmod +x /usr/local/bin/init-firewall.sh && \
  echo "node ALL=(root) NOPASSWD: /usr/local/bin/init-firewall.sh" > /etc/sudoers.d/node-firewall && \
  chmod 0440 /etc/sudoers.d/node-firewall
USER node

# Stage 2: Infrastructure
FROM base AS infrastructure

USER root

ARG TERRAFORM_VERSION
ARG TFLINT_VERSION
ARG CHECKOV_VERSION
ARG TERRAFORM_DOCS_VERSION

RUN ARCH=$(dpkg --print-architecture) && \
  wget "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}.0/terraform_${TERRAFORM_VERSION}.0_linux_${ARCH}.zip" && \
  unzip "terraform_${TERRAFORM_VERSION}.0_linux_${ARCH}.zip" && \
  mv terraform /usr/local/bin/ && rm "terraform_${TERRAFORM_VERSION}.0_linux_${ARCH}.zip" && \
  chmod +x /usr/local/bin/terraform

RUN ARCH=$(dpkg --print-architecture) && \
  if [ "$ARCH" = "amd64" ]; then ARCH_NAME="amd64"; elif [ "$ARCH" = "arm64" ]; then ARCH_NAME="arm64"; fi && \
  wget "https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VERSION}.0/tflint_linux_${ARCH_NAME}.zip" && \
  unzip "tflint_linux_${ARCH_NAME}.zip" && mv tflint /usr/local/bin/ && \
  rm "tflint_linux_${ARCH_NAME}.zip" && chmod +x /usr/local/bin/tflint

RUN apt-get update && apt-get install -y --no-install-recommends python3 python3-pip python3-venv \
  && apt-get clean && rm -rf /var/lib/apt/lists/* && \
  pip3 install --no-cache-dir checkov==${CHECKOV_VERSION}.* --break-system-packages

RUN ARCH=$(dpkg --print-architecture) && \
  if [ "$ARCH" = "amd64" ]; then ARCH_NAME="amd64"; elif [ "$ARCH" = "arm64" ]; then ARCH_NAME="arm64"; fi && \
  wget "https://github.com/terraform-docs/terraform-docs/releases/download/v${TERRAFORM_DOCS_VERSION}.0/terraform-docs-v${TERRAFORM_DOCS_VERSION}.0-linux-${ARCH_NAME}.tar.gz" && \
  tar -xzf "terraform-docs-v${TERRAFORM_DOCS_VERSION}.0-linux-${ARCH_NAME}.tar.gz" && \
  mv terraform-docs /usr/local/bin/ && rm "terraform-docs-v${TERRAFORM_DOCS_VERSION}.0-linux-${ARCH_NAME}.tar.gz" && \
  chmod +x /usr/local/bin/terraform-docs

USER node
WORKDIR /workspace

LABEL org.opencontainers.image.source="https://github.com/nakatatsu/mynote"
LABEL org.opencontainers.image.description="DevContainer Infrastructure Image"
LABEL maintainer="nakatatsu"
