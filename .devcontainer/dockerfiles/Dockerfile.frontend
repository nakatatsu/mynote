# DevContainer Frontend Image
# Self-contained multi-stage build for CI/CD frontend tasks

# Stage 1: Base
ARG NODE_VERSION
FROM node:${NODE_VERSION} AS base

ARG CLAUDE_CODE_VERSION
ARG AWS_CLI_VERSION
ARG GIT_DELTA_VERSION
ARG ZSH_IN_DOCKER_VERSION
ARG TZ=UTC

ENV TZ="$TZ"
ENV DEVCONTAINER=true
ENV NPM_CONFIG_PREFIX=/usr/local/share/npm-global
ENV PATH=$PATH:/usr/local/share/npm-global/bin
ENV SHELL=/bin/zsh
ENV EDITOR=nano
ENV VISUAL=nano

COPY scripts/install-base.sh /tmp/
RUN bash /tmp/install-base.sh && rm /tmp/install-base.sh

USER node

RUN sh -c "$(wget -O- https://github.com/deluan/zsh-in-docker/releases/download/v${ZSH_IN_DOCKER_VERSION}/zsh-in-docker.sh)" -- \
  -p git -p fzf \
  -a "source /usr/share/doc/fzf/examples/key-bindings.zsh" \
  -a "source /usr/share/doc/fzf/examples/completion.zsh" \
  -a "export PROMPT_COMMAND='history -a' && export HISTFILE=/commandhistory/.bash_history" \
  -x

RUN npm install -g @anthropic-ai/claude-code@${CLAUDE_CODE_VERSION}

COPY scripts/init-firewall.sh /usr/local/bin/
USER root
RUN chmod +x /usr/local/bin/init-firewall.sh && \
  echo "node ALL=(root) NOPASSWD: /usr/local/bin/init-firewall.sh" > /etc/sudoers.d/node-firewall && \
  chmod 0440 /etc/sudoers.d/node-firewall
USER node

# Stage 2: Frontend
FROM base AS frontend

ARG NEXTJS_VERSION

USER node

RUN npm install -g next@${NEXTJS_VERSION} react@latest react-dom@latest
RUN npm install -g typescript eslint prettier

WORKDIR /workspace

LABEL org.opencontainers.image.source="https://github.com/nakatatsu/mynote"
LABEL org.opencontainers.image.description="DevContainer Frontend Image"
LABEL maintainer="nakatatsu"
